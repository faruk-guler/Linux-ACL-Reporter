#!/bin/bash

# Ayarlar
OUTPUT="full_scan_report_$(date +%Y%m%d_%H%M%S).html"
START_DIR="${1:-/}"  # Argüman yoksa kök dizinden başla
MAX_DEPTH=5          # Varsayılan tarama derinliği

# HTML başlangıç
cat > "$OUTPUT" <<HTML_HEADER
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tam Dosya Sistemi İzin Raporu - $(hostname)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .danger {
            background-color: #ffdddd !important;
        }
        .warning {
            background-color: #fff3cd !important;
        }
        .permission-cell {
            font-family: monospace;
            font-weight: bold;
        }
        .summary {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Tam Dosya Sistemi İzin Raporu</h1>
    <div class="summary">
        <p><strong>Sistem:</strong> $(hostname)</p>
        <p><strong>Taranan Dizin:</strong> $START_DIR</p>
        <p><strong>Tarama Derinliği:</strong> $MAX_DEPTH</p>
        <p><strong>Rapor Tarihi:</strong> $(date "+%d.%m.%Y %H:%M:%S")</p>
    </div>
    <table>
        <thead>
            <tr>
                <th>Dosya/Dizin</th>
                <th>İzinler</th>
                <th>Sayısal</th>
                <th>Sahip</th>
                <th>Grup</th>
                <th>Boyut</th>
                <th>Son Değişim</th>
                <th>Durum</th>
            </tr>
        </thead>
        <tbody>
HTML_HEADER

# Tarama fonksiyonu
scan_files() {
    local current_dir="$1"
    local current_depth="$2"
    
    find "$current_dir" -maxdepth 1 -printf "%M %U %G %s %Tb %Td %TH:%TM %p\n" 2>/dev/null | while read -r perms owner group size month day time path; do
        # Mevcut dizini atla (sadece alt öğeleri işle)
        if [[ "$path" == "$current_dir" ]]; then
            continue
        fi

        # Sayısal izinleri hesapla
        numeric_perms=0
        [[ "${perms:1:1}" == "r" ]] && ((numeric_perms += 400))
        [[ "${perms:2:1}" == "w" ]] && ((numeric_perms += 200))
        [[ "${perms:3:1}" == "x" ]] && ((numeric_perms += 100))
        [[ "${perms:4:1}" == "r" ]] && ((numeric_perms += 40))
        [[ "${perms:5:1}" == "w" ]] && ((numeric_perms += 20))
        [[ "${perms:6:1}" == "x" ]] && ((numeric_perms += 10))
        [[ "${perms:7:1}" == "r" ]] && ((numeric_perms += 4))
        [[ "${perms:8:1}" == "w" ]] && ((numeric_perms += 2))
        [[ "${perms:9:1}" == "x" ]] && ((numeric_perms += 1))

        # Güvenlik durumu
        status=""
        class=""
        
        # Dizinler için kontrol
        if [[ "${perms:0:1}" == "d" ]]; then
            if [[ "$perms" == "drwxrwxrwx" ]]; then
                status="<span style='color:red;'>Güvensiz Dizin (777)</span>"
                class="danger"
            elif [[ "$numeric_perms" -gt 755 ]]; then
                status="<span style='color:orange;'>Riskli Dizin</span>"
                class="warning"
            fi
        # Dosyalar için kontrol
        else
            if [[ "$numeric_perms" -gt 644 && "$numeric_perms" -ne 755 ]]; then
                status="<span style='color:orange;'>Riskli İzin</span>"
                class="warning"
            fi
            
            if [[ "$numeric_perms" -eq 777 || "$numeric_perms" -eq 666 ]]; then
                status="<span style='color:red;'>Güvensiz Dosya</span>"
                class="danger"
            fi
            
            # SUID/SGID kontrolü
            if [[ "${perms:3:1}" == "s" || "${perms:6:1}" == "s" ]]; then
                status+=" <span style='color:orange;'>SUID/SGID</span>"
                [[ -z "$class" ]] && class="warning"
            fi
        fi

        # HTML satırını oluştur
        cat >> "$OUTPUT" <<HTML_ROW
            <tr class="$class">
                <td>$path</td>
                <td class="permission-cell">$perms</td>
                <td>$numeric_perms</td>
                <td>$owner</td>
                <td>$group</td>
                <td>$((size/1024)) KB</td>
                <td>$month $day $time</td>
                <td>$status</td>
            </tr>
HTML_ROW

        # Dizin ise ve maksimum derinliğe ulaşılmadıysa recursive tarama
        if [[ "${perms:0:1}" == "d" && "$current_depth" -lt "$MAX_DEPTH" ]]; then
            scan_files "$path" $((current_depth + 1))
        fi
    done
}

# Taramayı başlat (root ile çalıştırıldığından emin olun)
if [[ $EUID -ne 0 ]]; then
   echo "UYARI: Bu script tüm dosya sistemini tarayacağından root olarak çalıştırılmalıdır." >&2
   echo "       Bazı dosyalar/dizinler okunamayabilir." >&2
fi

scan_files "$START_DIR" 1

# HTML sonu
cat >> "$OUTPUT" <<HTML_FOOTER
        </tbody>
    </table>
    <div style="margin-top: 30px; font-size: 0.9em; color: #666; text-align: center;">
        <p>Rapor $(date "+%d.%m.%Y %H:%M:%S") tarihinde oluşturuldu</p>
        <p>Tarama derinliği: $MAX_DEPTH | Hariç tutulan dizin: YOK</p>
    </div>
</body>
</html>
HTML_FOOTER

echo "Rapor başarıyla oluşturuldu: $OUTPUT"
xdg-open "$OUTPUT" 2>/dev/null || echo "Raporı görüntülemek için tarayıcınızla $OUTPUT dosyasını açın."
